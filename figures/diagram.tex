\documentclass{amsart}
\usepackage{tikz}
\usetikzlibrary{external,decorations.pathreplacing,matrix,fit,calc,chains,scopes}
\tikzexternalize[force remake=true]
\tikzset{external/system call={pdflatex \tikzexternalcheckshellescape -halt-on-error -interaction=batchmode -jobname "\image" "\texsource"; pdftops -eps "\image".pdf "\image".eps}}


% Copied from signalflowdiagram.sty

%
% Colors
%
\newcommand{\pathdrawcolor}{\blockdrawcolor}     % draw color of signal paths
\newcommand{\pathfillcolor}{\blockfillcolor}     % fill color of signal paths
\newcommand{\operatordrawcolor}{\blockdrawcolor} % draw color of operators
\newcommand{\operatorfillcolor}{\blockfillcolor} % fill color of operators
\newcommand{\blockdrawcolor}{black}              % draw color of blocks
\newcommand{\blockfillcolor}{white}              % fill color of blocks

%
% line widths of
%
\newcommand{\diagramlinewidth}{0.5mm}  % signal flow diagram frames
\newcommand{\pathlinewidth}{0.3mm}     % signal paths
\newcommand{\operatorlinewidth}{0.3mm} % operator frames
\newcommand{\blocklinewidth}{0.5mm}    % building block styles

%
% line widths, sizes, etc.
%
\newcommand{\nodesize}{1.5mm}         % size of nodes
\newcommand{\terminalsize}{\nodesize} % size of terminals
\newcommand{\operatorsize}{3mm}       % size of circular shaped operator symbols
\newcommand{\delaysize}{6mm}          % minimum size of delay elements
\newcommand{\blockwidth}{24mm}        % minimum width of blocks
\newcommand{\blockheight}{12mm}       % minimum height of blocks
\newcommand{\blocktextwidth}{22mm}    % minimum text width of blocks
\newcommand{\filterwidth}{12mm}       % minimum width of filters
\newcommand{\filterheight}{8mm}       % minimum height of filters
\newcommand{\filtertextwidth}{6mm}    % minimum text width of filters
\usetikzlibrary{signalflowoperators}


\begin{document}

\tikzstyle{junction}=[draw, fill, circle, line width=0pt, inner sep=0pt, minimum size=3pt]
\tikzstyle{signal}=[draw, fill=white, circle, inner sep=0pt, minimum size=4pt]
\tikzstyle{resample}=[draw, circle, line width=1pt, inner sep=0pt, minimum size=0.3cm]
\tikzstyle{vdots}=[xshift=-0.75mm, inner sep=0pt, text width=0pt, minimum size=0pt]

\tikzsetnextfilename{lloid-diagram}
\begin{tikzpicture}[
	every label/.style={text height=4pt},
	column sep=1mm,
	row sep=1mm,
	node distance=2mm,
	every path/.style={line width=1pt},
	every node/.style={line width=1pt, anchor=center}
]

	\matrix (m) [
		matrix of nodes,
		column 1/.style={column sep=8mm},
		column 2/.style={column sep=15mm},
		column 3/.style={column sep=3mm},
		column 4/.style={column sep=8mm},
		column 5/.style={column sep=15mm},
		column 6/.style={column sep=8mm},
		column 11/.style={column sep=8mm}
	]{
		& \node[yshift=0.5cm](in){}; & \node[yshift=0.5cm](intee){}; & \node[yshift=0.5cm](u){}; & \node[yshift=0.5cm](utee){}; & \node[yshift=0.5cm](v){}; & \node[yshift=0.5cm](add0){}; & \node[yshift=0.5cm](add1){}; & \node[yshift=0.5cm](add2){}; & & \node[yshift=0.5cm](add3){}; & \node[yshift=0.5cm](out){}; \\
		& & & \node[draw] (u00) {}; & \node[junction] (u00tee) {}; & \node[adder] (v00) {}; & \node[adder] (add00) {}; & & & & & \node[signal, label=right:{$\rho_0^0$}] (out00) {}; \\
		& & & \node[draw] (u10) {}; & \node[junction] (u10tee) {}; & \node[adder] (v10) {}; & & \node[adder] (add10) {}; & & & & \node[signal, label=right:{$\rho_1^0$}] (out10) {}; \\
		\node[signal, label=left:{$x$}] (x) {}; & \node[junction] (in0) {}; & \node[junction] (in0tee) {}; & & & \node[adder] (v20) {}; & & & \node[adder] (add20) {}; & & & \node[signal, label=right:{$\rho_2^0$}] (out20) {}; \\
		& & & & & \node[vdots]{$\colon$}; & & & & & & \node[vdots]{$\colon$}; \\
		& & & \node[draw] (u20) {}; & \node[junction] (u20tee) {}; & \node[adder] (v30) {}; & & & & & \node[adder] (add30) {}; & \node[signal, label=right:{$\rho_{M-1}^0$}] (out30) {}; \\
		& & & & & & & & \node[minimum height=6mm](delay0){}; & & & \\
		& & & & & & \node[resample] (resample01) {\tiny$\uparrow$}; & \node[resample] (resample11) {\tiny$\uparrow$}; & \node[resample] (resample21) {\tiny$\uparrow$}; & \node{$\cdot \cdot$}; & \node[resample] (resample31) {\tiny$\uparrow$}; \\
%
		& & & \node[draw] (u01) {}; & \node[junction] (u01tee) {}; & \node[adder] (v01) {}; & \node[adder] (add01) {}; & & & & & \node[signal, label=right:{$\rho_0^1$}] (out01) {}; \\
		& & & \node[draw] (u11) {}; & \node[junction] (u11tee) {}; & \node[adder] (v11) {}; & & \node[adder] (add11) {}; & & & & \node[signal, label=right:{$\rho_1^1$}] (out11) {}; \\
		& \node[resample] (in1) {\tiny$\downarrow$}; & \node[junction] (in1tee) {}; & & & \node[adder] (v21) {}; & & & \node[adder] (add21) {}; & & & \node[signal, label=right:{$\rho_2^1$}] (out21) {}; \\
		& & & & & \node[vdots]{$\colon$}; & & & & & & \node[vdots]{$\colon$}; \\
		& & & \node[draw] (u21) {}; & \node[junction] (u21tee) {}; & \node[adder] (v31) {}; & & & & & \node[adder] (add31) {}; & \node[signal, label=right:{$\rho_{M-1}^1$}] (out31) {}; \\
		& & & & & & & & \node[minimum height=6mm](delay1){}; & & & \\
		& & & & & & \node[resample] (resample02) {\tiny$\uparrow$}; & \node[resample] (resample12) {\tiny$\uparrow$}; & \node[resample] (resample22) {\tiny$\uparrow$}; & \node{$\cdot \cdot$}; & \node[resample] (resample32) {\tiny$\uparrow$}; \\
%
		& \node[minimum size=0pt, text height=8pt, anchor=base] (invdots) {$\vdots$}; & & \node[minimum size=0pt, text height=0pt, anchor=base] {$\vdots$}; & \node[minimum size=0pt, text height=8pt, anchor=base] {$\vdots$}; & \node[minimum size=0pt, text height=8pt, anchor=base] {$\vdots$}; & \node[minimum height=8pt]{}; & & & & & \node[minimum size=0pt, text height=0pt, anchor=base] {$\vdots$}; \\
		& & & & & & \node[minimum size=0pt, text height=8pt] (vdots0) {$\vdots$}; & \node[minimum size=0pt, text height=8pt] (vdots1) {$\vdots$}; & \node[minimum size=0pt, text height=8pt] (vdots2) {$\vdots$}; & & \node[minimum size=0pt, text height=8pt] (vdots3) {$\vdots$}; \\
%
		& & & \node[draw] (u02) {}; & \node[junction] (u02tee) {}; & \node[adder] (v02) {}; & \node[junction] (add02) {}; & & & & & \node[signal, label=right:{$\rho_0^{S-1}$}] (out02) {}; \\
		& & & \node[draw] (u12) {}; & \node[junction] (u12tee) {}; & \node[adder] (v12) {}; & & \node[junction] (add12) {}; & & & & \node[signal, label=right:{$\rho_1^{S-1}$}] (out12) {}; \\
		& \node[junction] (in2) {}; & \node[junction] (in2tee) {}; & & & \node[adder] (v22) {}; & & & \node[junction] (add22) {}; & & & \node[signal, label=right:{$\rho_2^{S-1}$}] (out22) {}; \\
		& & & & & \node[vdots]{$\colon$}; & & & & & & \node[vdots]{$\colon$}; \\
		& & & \node[draw] (u22) {}; & \node[junction] (u22tee) {}; & \node[adder] (v32) {}; & & & & & \node[junction] (add32) {}; & \node[signal, label=right:{$\rho_{M-1}^{S-1}$}] (out32) {}; \\
	};

	\foreach \i in {0,1,2} {
		\draw[loosely dotted] ($0.3*(add2\i) + 0.7*(add3\i)$) -- ($0.7*(add2\i) + 0.3*(add3\i)$);
		\node[draw,dashed,line width=0.5pt,fit=(in\i tee) (u0\i) (u2\i)] {};
		\node[draw,dashed,line width=0.5pt,yshift=0.5mm,fit=(u0\i tee) (v3\i)] {};
		\foreach \j in {0,1,2,3}
			\foreach \k in {0,1,2}
				\draw[->] (u\k \i tee) -- (v\j \i) -- (add\j \i);
		\foreach \k in {0,1,2}
			\draw (in\i tee) |- (u\k \i) -- (u\k \i tee);
		\node[vdots] at ($0.5*(u1\i tee) + 0.5*(u2\i tee)$) {$\vdots$};
		\node[vdots] at ($0.5*(u1\i) + 0.5*(u2\i)$) {$\vdots$};
	}

	\foreach \i in {1,2}
		\foreach \j in {0,1,2,3}
			\draw[->, dashed] (add\j \i) -- (out\j \i);

	\foreach \j in {0,1,2,3}
		\draw[->] (add\j 0) -- (out\j 0);

	\draw (in0) -- (in0tee) node[midway,above] {\small 4096 Hz};
	\draw (in1) -- (in1tee) node[midway,above] {\small 512 Hz};
	\draw (in2) -- (in2tee) node[midway,above] {\small 32 Hz};

	\foreach \i in {0,1,2,3} {
		\draw[->] (resample\i 1) -- (add\i 0);
		\draw[->] (resample\i 2) -- (add\i 1);
		\draw (add\i 2) -- (vdots\i);
		\draw[->] (vdots\i) -- (resample\i 2);
		\draw[->] (add\i 1) -- (resample\i 1);
	}
	
	\node[draw,fill=white,minimum width=22mm,xshift=1mm,label=right:{\small delay}] at (delay0) {\tiny$z^{-t^1 f^0}$};
	\node[draw,fill=white,minimum width=22mm,xshift=1mm,label=right:{\small delay}] at (delay1) {\tiny$z^{-(t^2-t^1) f^1}$};
	\draw[->] (in0) -- (in1);
	\draw (in1) -- (invdots);
	\draw[->] (invdots) -- (in2);
	\draw[->] (x) -- (in0);

	\draw[decorate, decoration={brace, amplitude=4pt}] ($(in)+(-4mm,0)$) -- ($(in)+(4mm,0)$) node[midway,above=2mm,align=center] {Decimation \\ of input};
	\draw[decorate, decoration={brace, amplitude=4pt}] ($(intee)+(-2mm,0)$) -- ($(u)+(2mm,0)$) node[midway,above=2mm,align=center] {Orthogonal \\ \textsc{fir} filters};
	\draw[decorate, decoration={brace, amplitude=4pt}] ($(utee)+(-2mm,0)$) -- ($(v)+(2mm,0)$) node[midway,above=2mm,align=center] {Reconstruction \\ matrices};
	\draw[decorate, decoration={brace, amplitude=4pt}] ($(add0)+(-2mm,0)$) -- ($(add3)+(2mm,0)$) node[midway,above=2mm,align=center] {Interpolation and \\ \textsc{snr} accumulation};
\end{tikzpicture}


\tikzsetnextfilename{upsample-symbol}
\begin{tikzpicture}
	\node[resample] {\tiny$\uparrow$};
\end{tikzpicture}


\tikzsetnextfilename{downsample-symbol}
\begin{tikzpicture}
	\node[resample] {\tiny$\downarrow$};
\end{tikzpicture}


\tikzsetnextfilename{adder-symbol}
\begin{tikzpicture}
	\node[line width=1pt,adder] {};
\end{tikzpicture}


\tikzsetnextfilename{fir-symbol}
\begin{tikzpicture}
	\node[line width=1pt,draw] {};
\end{tikzpicture}


\end{document}
